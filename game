#!/bin/bash

# The Game - Main command interface
# Provides game commands like: game load rogue, game status, game dojo, etc.

set -euo pipefail

readonly GAME_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPTS_DIR="$GAME_ROOT/WORLD/scripts"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'

# ============================================================================
# COMMANDS
# ============================================================================

cmd_load() {
  local build="${1:-}"
  [ -z "$build" ] && die "Usage: game load [build-name]"
  
  "$SCRIPTS_DIR/load-build.sh" "$build"
}

cmd_status() {
  echo -e "${BLUE}ðŸ“Š Game Status:${NC}"
  echo ""
  
  if [ -f "$GAME_ROOT/CHARACTER/build.md" ]; then
    echo -e "${GREEN}Active Build:${NC}"
    head -5 "$GAME_ROOT/CHARACTER/build.md" | tail -3
    echo ""
  fi
  
  if [ -f "$GAME_ROOT/RESUME.md" ]; then
    echo -e "${GREEN}Current Session:${NC}"
    grep "Working on:" "$GAME_ROOT/RESUME.md" | head -1
    echo ""
  fi
}

cmd_quest() {
  if [ -f "$GAME_ROOT/QUESTLOG/active.md" ]; then
    cat "$GAME_ROOT/QUESTLOG/active.md"
  else
    echo "No active quest"
  fi
}

cmd_inventory() {
  if [ -f "$GAME_ROOT/INVENTORY/equipped.json" ]; then
    echo -e "${BLUE}ðŸ“¦ Equipped Gear:${NC}"
    jq '.gear' "$GAME_ROOT/INVENTORY/equipped.json"
  fi
}

cmd_help() {
  cat << 'EOF'
The Game - AI Game Saves Framework

COMMANDS:
  game load [build]       Load a build (wizard, warrior, ranger, paladin, rogue)
  game status             Show current game status
  game quest              Show active quest
  game inventory          Show equipped gear
  game dojo               Enter training dojo
  game help               Show this help

EXAMPLES:
  game load rogue         # Load rogue build and sync MCP
  game status             # Check current state
  game quest              # See active quest

EOF
}

cmd_dojo() {
  local build_file="$GAME_ROOT/CHARACTER/build.md"
  
  if [ ! -f "$build_file" ]; then
    echo -e "${RED}âœ— No build loaded. Use 'game load [build]' first.${NC}"
    return 1
  fi
  
  echo -e "${BLUE}ðŸ¥‹ Entering the Dojo...${NC}"
  echo ""
  cat "$build_file"
}

# ============================================================================
# UTILITIES
# ============================================================================

die() {
  echo -e "${RED}âœ— $*${NC}" >&2
  exit 1
}

# ============================================================================
# MAIN
# ============================================================================

main() {
  local cmd="${1:-help}"
  
  case "$cmd" in
    load)
      cmd_load "${2:-}"
      ;;
    status)
      cmd_status
      ;;
    quest)
      cmd_quest
      ;;
    inventory)
      cmd_inventory
      ;;
    dojo)
      cmd_dojo
      ;;
    help|--help|-h)
      cmd_help
      ;;
    *)
      echo -e "${RED}Unknown command: $cmd${NC}"
      cmd_help
      exit 1
      ;;
  esac
}

main "$@"
